local json = require ("dkjson")
local https = require('ssl.https')
local ltn12 = require("ltn12")

function bitstamp_table()
	-- Keys: low, ask, high, volume, timestamp, last, bid
	-- for k, v in pairs(bitstamp_table) do print(k, v) end
	local resp = {}
	https.request{
		url = "https://www.bitstamp.net:443/api/ticker/",
		sink = ltn12.sink.table(resp),
		protocol = "tlsv1"
	}
	assert(resp[1])
	return(json.decode(resp[1]))
end

function get_price(key)
	-- Return the last price from bitstamp.net
	local price = bitstamp_table()[key]
	return(price)
end

last_price = get_price("last") -- This must be global (so that awesome-client can alter it)
btc_colour = "#fff"

-- {{{ Wibox
bitstampwidget = wibox.widget.textbox()

-- Register the Bitstamp timer listner
bitstamp_timer = timer({ timeout = 1 })
bitstamp_timer:connect_signal("timeout", function()
	bitstampwidget:set_markup('<span color="' .. btc_colour ..'">$' .. last_price .. '</span> ')
end)
bitstamp_timer:start()

-- Append to your taskbar
right_layout:add(bitstampwidget)
